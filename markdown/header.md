# 头文件相关代码规范  

## 头文件编写基本原则

### 原则1 头文件中适合放置接口的声明，不适合放置实现。  

说明：头文件是模块（Module）或单元（Unit）的对外接口。头文件中应放置对外部的声明，如对外提供的函数声明、宏定义、类型定义等。  

### 原则2 头文件应当职责单一。  

说明：头文件过于复杂，依赖过于复杂是导致编译时间过长的主要原因。很多现有代码中头文件过大，职责过多，再加上循环依赖的问题，可能导致为了在.c中使用一个宏，而包含十几个头文件。  

### 原则3 头文件应向稳定的方向包含。  

说明：头文件的包含关系是一种依赖，一般来说，应当让不稳定的模块依赖稳定的模块，从而当不稳定的模块发生变化时，不会影响（编译）稳定的模块。  

## 头文件编写具体规则  

### 规则1 每一个.c文件应有一个同名.h文件，用于声明需要对外公开的接口。  

说明：C语言通过包含头文件来获取其它模块在头文件中对外提供的函数声明、宏定义、类型定义等信息，所以在实现一个模块或单元时，要将此模块或单元对外提供的接口声明在头文件中，对于宏定义，类型定义同同理。注意，无需对外公开的部分不要包含到头文件中，如内部调用的函数，内部使用的类型等，并且尽可能去用static修饰私有的函数，变量，防止污染全局的命名空间。

### 规则2 单独包含任意一个头文件后可以编译通过。

说明：如果包含某个头文件时，还要包含另外一个头文件才能工作的话，就会增加交流障碍，给这个头文件的用户增添不必要的负担。

### 规则3 .c/.h文件禁止包含用不到的头文件。

由此规则，可以得到另一个的衍生规则，即应该优先在.c文件内进行include另一个头文件，除非.h文件中用到了被包含文件中的接口或定义等(即要满足规则2)，才会在.h文件中include。

### 规则4 禁止头文件循环依赖  

说明：头文件循环包含，指a.h包含b.h，b.h包含c.h，c.h包含a.h之类的行为。  
头文件循环包含，除了编译时所产生额外的开销，在实际写代码过程中遇到了产生一些在单独编译单个模块时没有异常，但是在使用时包含后出现undeclared的情况。经过排查后发现是循环include所造成的结果。    
造成的此类错误可以抽象成以下这种简单例子，但是往往在工程中出现这种错误时需要耗费非常大的精力去排查。  

```c
//example:
//a.h
#ifndef CTEST_A_H
#define CTEST_A_H

#include "b.h"

typedef unsigned char u8;

struct A{
    u32 m_u32;
};

#endif

//b.h
#ifndef CTEST_B_H
#define CTEST_B_H

#include "a.h"

typedef unsigned int u32;

struct B{
    u8 m_u8;
};

#endif 

//main.c
#include "a.h"

int main(){
    struct A a;
}

//编译器输出：error: 'u8' does not name a type

```

部分循环依赖的情况可以通过严格遵守规则3避免，如果无法避免可能需要梳理代码结构进行更好的设计和改进。  
头文件循环依赖的情况并不一定会导致错误，但是违反了我们的原则3 头文件应向稳定的方向包含。并且如果项目中出现例子中的错误，往往难以排查，所以我们建议从源头改善，禁止出现循环依赖的情况。  

### 规则5 总是编写内部#include保护符（#define 保护）  

说明：阻止头文件内容被包含多于一次的机制。  
所有头文件都应当使用#define 防止头文件被多重包含，命名格式为FILENAME_H，FILENAME可以包含部分路径，防止重复定义。  
这里不建议用下划线或双下划线开头，因为下划线开头的标识符作为编译器或库的保留字使用，我们在自己写代码时尽量不要使用。  

### 规则6 禁止在头文件中定义变量。

说明：在头文件中定义变量，将会由于头文件被其他.c文件包含而导致变量重复定义。

### 规则7 只能通过包含头文件的方式使用其他.c提供的接口，禁止在.c中通过extern的方式使用外部函数接口、变量。

## 头文件编写的一些建议

### 建议1 一个模块如果包含多个.c文件，建议放在同一个目录下，目录名即为模块名。为方便外部使用者，建议每一个模块提供一个.h，文件名为目录名。

说明：需要注意的是，这个.h并不是简单的包含所有内部的.h，它是为了模块使用者的方便，对外整体提供的模块接口。

### 建议2 统一包含头文件排列方式。

说明：常见的包含头文件排列方式：功能块排序、文件名升序、稳定度排序。  
如果对头文件的排列顺序有要求，那么显然的违反了规则2。  
